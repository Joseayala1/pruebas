DECLARE @RC INT
DECLARE @IDEMPRESA INT = CAST ('20727' AS INT);
DECLARE @IDUSUARIO INT = CAST ('31158' AS INT);
DECLARE @TK VARCHAR(MAX) = 'CER-D512E95F-F590-40FD-A647-8ECDC69EAC54'
DECLARE @CERTEZAS VARCHAR(MAX) = ''
DECLARE @OCULTARCERTEZAS INT = NULLIF (CAST ('' AS INT), '')
DECLARE @FILTRAR INT = NULLIF (CAST ('' AS INT), '')

-- Manejo de paginación con helpers
DECLARE @OFFSET INT = CAST ('0' AS INT)
DECLARE @LEN INT = CAST ('50' AS INT)

-- Base de datos... ningun parámetro de texto a partir de aquí...
USE [SALESUP_DB0];


SET @TK = LTRIM(RTRIM(ISNULL(@TK, '')))
SET @FILTRAR = ISNULL(@FILTRAR, 0)

DECLARE @CERTEZA_TABLA TABLE (
    ID INT IDENTITY(1,1),
    TK VARCHAR(64),
    DESCRIPCION VARCHAR(1000),
    DESCRIPCIONCORPORATIVA VARCHAR(1000),
    TKM VARCHAR(64)
)
DECLARE @INDICE INT = 1,
    @FIN INT,
    @TKM VARCHAR(64),
    @DESCRIPCION VARCHAR(1000),
    @DESCIPCIONCORPORATIVA VARCHAR(1000),
    @TKE VARCHAR(64),
    @DATA VARCHAR(MAX),
    @MENSAJE VARCHAR(MAX),
    @EMPREZACANALIZADA INT

SELECT @TKE = TKE FROM SALESUP_CT.DBO.EMPRESAS WHERE IDEMPRESA = @IDEMPRESA

SET @CERTEZAS = ISNULL(@CERTEZAS, '')
SET @OCULTARCERTEZAS = ISNULL(@OCULTARCERTEZAS, -1)

IF(@OCULTARCERTEZAS <> -1)
BEGIN
    IF(@OCULTARCERTEZAS IN (0,1))
    BEGIN
        UPDATE DBO.EMPRESAS WITH(ROWLOCK) 
        SET OCULTAR_CERTEZAS_SINDESC = @OCULTARCERTEZAS 
        WHERE IDEMPRESA = @IDEMPRESA
        
        EXEC dbo.PA_ENVIA_SQS_CATALOGOS_V4 @IDEMPRESA, @IDUSUARIO, 'certezas'
        SELECT 0 code, 'Ok' msg, '[{"tkEmpresa":"'+@TKE+'", "ocultarCertezas":"'+@OCULTARCERTEZAS+'"}]' details
        RETURN
    END
    ELSE
    BEGIN
        SELECT 1 AS code, 'El valor de ocultarCertezas no es valido.'
        RETURN
    END
END

IF (@CERTEZAS <> '') -- ACTUALIZA
BEGIN

BEGIN TRY
    INSERT INTO @CERTEZA_TABLA (TK, DESCRIPCION, DESCRIPCIONCORPORATIVA, TKM)
    SELECT
        MAX(CASE WHEN NAME = 'TKCERTEZA' THEN STRINGVALUE ELSE NULL END) AS TK,
        MAX(CASE WHEN NAME = 'DESCRIPCION' THEN STRINGVALUE ELSE NULL END) AS DESCRIPCION,
        MAX(CASE WHEN NAME = 'DESCRIPCIONCORPORATIVA' THEN STRINGVALUE ELSE NULL END) AS DESCRIPCIONCORPORATIVA,
        MAX(CASE WHEN NAME = 'TKMAESTRO' THEN STRINGVALUE ELSE NULL END) AS TKM
    FROM SALESUP_CT.DBO.PARSEJSON(@CERTEZAS)
    WHERE OBJECT_ID IS NULL
    GROUP BY PARENT_ID

    SET @EMPREZACANALIZADA = (SELECT 1
        FROM SALESUP_CT.DBO.EMPRESAS WITH(NOLOCK)
        WHERE IDEMPRESA = @IDEMPRESA AND TKE = TKM AND TKE IS NOT NULL AND TKE IS NOT NULL)
        
    DELETE FROM @CERTEZA_TABLA WHERE TK IS NULL

    WHILE((SELECT TOP 1 1 FROM @CERTEZA_TABLA) = 1)
    BEGIN
        SELECT TOP 1
            @DESCRIPCION = DESCRIPCION,
            @DESCIPCIONCORPORATIVA = DESCRIPCIONCORPORATIVA,
            @TK = TK,
            @TKM = TKM
        FROM @CERTEZA_TABLA

        IF(@TK IS NOT NULL)
        BEGIN
            -- PreparaCadena() --> Para formatear palabras con acentos.
            IF(ISNULL(@TKM,'') <> '')
            BEGIN
                SET @TKM = (SELECT TKM
                FROM EMPRESAS_CERTEZAS WITH(NOLOCK)
                WHERE IDEMPRESA = @IDEMPRESA AND TK = @TK)
            END

            --SET @ESCANALIZADO = (SALESUP_CT.DBO.esCanalizado(@TK,@TKM))
            --IF(@DESCRIPCION = '') BEGIN SET @DESCRIPCION = NULL END
            --IF(@DESCIPCIONCORPORATIVA = '') BEGIN SET @DESCIPCIONCORPORATIVA = NULL END

            UPDATE DBO.EMPRESAS_CERTEZAS WITH(ROWLOCK)
            SET 
                DESCRIPCION = ISNULL((select salesup_ct.dbo.PreparaCadena(@DESCRIPCION)), EC.descripcion),
                ULTIMAMODIFICACION = GETDATE(),
                --DESCRIPCION_CORPORATIVA = ISNULL((select salesup_ct.dbo.PreparaCadena(@DESCIPCIONCORPORATIVA)), EC.DESCRIPCION_CORPORATIVA),
                TKM = @TKM
            FROM EMPRESAS_CERTEZAS EC
            WHERE EC.IDEMPRESA = @IDEMPRESA AND EC.TK = @TK
        END

        DELETE TOP(1) FROM @CERTEZA_TABLA
    END
    
    EXEC dbo.PA_ENVIA_SQS_CATALOGOS_V4 @IDEMPRESA, @IDUSUARIO, 'certezas'
    SELECT 0 code, 'Ok' msg, @CERTEZAS details
END TRY
BEGIN CATCH
    SELECT 1 AS resultado, 'Ha ocurrido un error al intentar actualizar la certeza' as msg
END CATCH

END
